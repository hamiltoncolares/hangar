generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tier {
  id        String   @id @default(uuid())
  nome      String
  marginMeta Decimal? @map("margin_meta")
  clientes  Cliente[]
  userTiers UserTier[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tiers")
}

model Cliente {
  id        String    @id @default(uuid())
  nome      String
  logoUrl   String?   @map("logo_url")
  marginMeta Decimal? @map("margin_meta")
  tierId    String    @map("tier_id")
  tier      Tier      @relation(fields: [tierId], references: [id])
  projetos  Projeto[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([tierId, nome])
  @@map("clientes")
}

model Projeto {
  id        String           @id @default(uuid())
  nome      String
  status    String           @default("ativo")
  marginMeta Decimal?        @map("margin_meta")
  clienteId String           @map("cliente_id")
  cliente   Cliente          @relation(fields: [clienteId], references: [id])
  impostos  Imposto[]
  registros RegistroMensal[]
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  @@unique([clienteId, nome])
  @@map("projetos")
}

model Imposto {
  id             String   @id @default(uuid())
  projetoId      String   @map("projeto_id")
  projeto        Projeto  @relation(fields: [projetoId], references: [id])
  percentual     Decimal
  vigenciaInicio DateTime @map("vigencia_inicio")
  vigenciaFim    DateTime? @map("vigencia_fim")
  ativo          Boolean  @default(true)
  registros      RegistroMensal[]
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("impostos")
}

model RegistroMensal {
  id            String   @id @default(uuid())
  projetoId     String   @map("projeto_id")
  projeto       Projeto  @relation(fields: [projetoId], references: [id])
  mesRef        DateTime @map("mes_ref")
  receitaBruta  Decimal  @map("receita_bruta")
  impostoId     String   @map("imposto_id")
  imposto       Imposto  @relation(fields: [impostoId], references: [id])
  receitaLiquida Decimal @map("receita_liquida")
  custoProjetado Decimal @map("custo_projetado")
  marginMeta    Decimal? @map("margin_meta")
  status        String
  observacoes   String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([projetoId, mesRef, status])
  @@map("registros_mensais")
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  name         String?
  passwordHash String     @map("password_hash")
  role         String     @default("user")
  status       String     @default("pending")
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lockedUntil  DateTime?  @map("locked_until")
  tiers        UserTier[]
  auditLogs    AuditLog[] @relation("AuditActor")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  lastLoginAt  DateTime?  @map("last_login_at")

  @@map("users")
}

model UserTier {
  id        String  @id @default(uuid())
  userId    String  @map("user_id")
  tierId    String  @map("tier_id")
  user      User    @relation(fields: [userId], references: [id])
  tier      Tier    @relation(fields: [tierId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, tierId])
  @@map("user_tiers")
}

model AuditLog {
  id           String   @id @default(uuid())
  actorId      String   @map("actor_id")
  targetUserId String?  @map("target_user_id")
  action       String
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  actor        User     @relation("AuditActor", fields: [actorId], references: [id])

  @@map("audit_logs")
}
